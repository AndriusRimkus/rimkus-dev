---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import AsideLayout from '@/layouts/AsideLayout.astro';
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogPostArticle from '@/components/BlogPostArticle.astro';
import RelatedPostsSidebar from '@/components/RelatedPostsSidebar.astro';

type Props = CollectionEntry<'blog'>;

const { data } = Astro.props;
const { title, description, category } = data;

const allPosts = await getCollection('blog');

const relatedPosts = allPosts
    .filter((post) => post.data.category === category)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const showSidebar = relatedPosts.length > 1;
---

{
    showSidebar ? (
        <AsideLayout title={title} description={description}>
            <BlogPostArticle title={title} category={category}>
                <slot />
            </BlogPostArticle>

            <RelatedPostsSidebar slot="aside" relatedPosts={relatedPosts} currentPost={Astro.props} />
        </AsideLayout>
    ) : (
        <BaseLayout title={title} description={description}>
            <BlogPostArticle title={title} category={category}>
                <slot />
            </BlogPostArticle>
        </BaseLayout>
    )
}
